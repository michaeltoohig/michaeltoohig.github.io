<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Custom Extensions for Directus â€” Michael Toohig</title><meta content="How to get started with self-hosting Directus and write custom extensions." name=description><meta content=index,follow name=robots><link href=https://michaeltoohig.com/blog/directus-extensions rel=canonical><meta content="Custom Extensions for Directus" property=og:title><meta content="How to get started with self-hosting Directus and write custom extensions." property=og:description><meta content=https://michaeltoohig.com/blog/directus-extensions property=og:url><meta content=article property=og:type><meta content=https://michaeltoohig.com/_astro/cover.D42Nh0OP.png property=og:image><meta content="Custom Extensions for Directus" property=og:image:alt><meta content=summary_large_image name=twitter:card><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#E37D3A;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=orcPxI47GSa-cRvY11tUe6iGg2IO_RPvnA1q95iEM3M name=google-site-verification><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/about.DalL60B6.css rel=stylesheet><style>.link-preview[data-astro-cid-ztfdmrby]{--lp-width:var(--link-preview-width, 30em);--lp-pad-x:var(--link-preview-padding-inline, 0);--lp-pad-y:var(--link-preview-padding-block, .5em);--lp-corners:var(--link-preview-corners, 0);--lp-desc-lines:var(--link-preview-description-lines, 1);position:relative;width:var(--lp-width);max-width:100%;display:flex;flex-direction:column-reverse;border-radius:var(--lp-corners)}.link-preview[data-astro-cid-ztfdmrby] [data-astro-cid-ztfdmrby]{margin:0!important}.link-preview__content[data-astro-cid-ztfdmrby]{display:flex;flex-direction:column;padding:var(--lp-pad-y) var(--lp-pad-x)}.link-preview[data-astro-cid-ztfdmrby] header[data-astro-cid-ztfdmrby]{display:flex;flex-direction:column-reverse}.link-preview__description[data-astro-cid-ztfdmrby]{display:-webkit-box;-webkit-line-clamp:var(--lp-desc-lines);-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}.link-preview[data-astro-cid-ztfdmrby]:not(.link-preview--has-video) a[data-astro-cid-ztfdmrby]:after{content:"";position:absolute;inset:0}.link-preview[data-astro-cid-ztfdmrby] img[data-astro-cid-ztfdmrby],.link-preview[data-astro-cid-ztfdmrby] video[data-astro-cid-ztfdmrby]{aspect-ratio:1200/630;width:100%;height:auto;-o-object-fit:cover;object-fit:cover;border-top-left-radius:var(--lp-corners);border-top-right-radius:var(--lp-corners)}</style><style>.twitter-tweet:not(.twitter-tweet-rendered){padding:var(--tc-padding,1em);border:1px solid var(--tc-border-color,#cfd9de)}.twitter-tweet:not(.twitter-tweet-rendered)>:first-child{margin-top:0}.twitter-tweet:not(.twitter-tweet-rendered)>:last-child{margin-bottom:0}.twitter-tweet.twitter-tweet-rendered{color-scheme:normal}</style><style>lite-vimeo{font-size:10px;background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover}lite-vimeo:after{content:"";display:block;padding-bottom:56.25%}lite-vimeo>iframe{all:unset!important;width:100%!important;height:100%!important;position:absolute!important;inset:0!important;border:0!important}lite-vimeo>.ltv-playbtn{content:"";position:absolute;inset:0;width:100%;background:0 0;outline:0;border:0;cursor:pointer}lite-vimeo>.ltv-playbtn:before{width:6.5em;height:4em;background:#172322bf;opacity:.8;border-radius:.25rem;transition:all .2s cubic-bezier(0,0,.2,1)}lite-vimeo>.ltv-playbtn:focus:before{outline:auto}lite-vimeo:hover>.ltv-playbtn:before{background-color:#00adef;background-color:var(--ltv-color,#00adef);opacity:1}lite-vimeo>.ltv-playbtn:after{border-style:solid;border-width:1em 0 1em 1.7em;border-color:transparent transparent transparent #fff}lite-vimeo>.ltv-playbtn:after,lite-vimeo>.ltv-playbtn:before{content:"";position:absolute;top:50%;left:50%;transform:translate3d(-50%,-50%,0)}lite-vimeo.ltv-activated:before,lite-vimeo.ltv-activated>.ltv-playbtn{cursor:unset;opacity:0;pointer-events:none}</style><style>lite-youtube>iframe{all:unset!important;width:100%!important;height:100%!important;position:absolute!important;inset:0!important;border:0!important}</style><style>lite-youtube{background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover;cursor:pointer;max-width:720px}lite-youtube:before{content:attr(data-title);display:block;position:absolute;top:0;background-image:linear-gradient(180deg,#000000ab,#0000008a 14%,#00000026 54%,#0000000d 72%,#0000 94%);height:99px;width:100%;font-family:YouTube Noto,Roboto,Arial,Helvetica,sans-serif;color:#eee;text-shadow:0 0 2px rgba(0,0,0,.5);font-size:18px;padding:25px 20px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;box-sizing:border-box}lite-youtube:hover:before{color:#fff}lite-youtube:after{content:"";display:block;padding-bottom:56.25%}lite-youtube>iframe{width:100%;height:100%;position:absolute;top:0;left:0;border:0}lite-youtube>.lty-playbtn{display:block;width:100%;height:100%;background:no-repeat center/68px 48px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');position:absolute;cursor:pointer;z-index:1;filter:grayscale(100%);transition:filter .1s cubic-bezier(0,0,.2,1);border:0}lite-youtube .lty-playbtn:focus,lite-youtube:hover>.lty-playbtn{filter:none}lite-youtube.lyt-activated{cursor:unset}lite-youtube.lyt-activated:before,lite-youtube.lyt-activated>.lty-playbtn{opacity:0;pointer-events:none}.lyt-visually-hidden{clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;overflow:hidden;position:absolute;white-space:nowrap;width:1px}</style><script src=/_astro/Vimeo.astro_astro_type_script_index_0_lang.CgRsrQuG.js type=module></script><script src=/_astro/YouTube.astro_astro_type_script_index_0_lang.Dkyb9mLy.js type=module></script></head><body class="dark:bg-dark antialiased bg-light dark:text-slate-300 text-page tracking-tight"><div class=block></div><header class="mx-auto w-full duration-100 ease-in flex-none relative top-0 transition-all z-40" id=header><div class="mx-auto w-full max-w-7xl md:flex md:justify-between md:px-4 md:py-3.5 px-3 py-3"><div class="flex justify-between"><a href=/ class="items-center flex"><span class="font-bold dark:text-white md:text-xl ml-2 self-center text-2xl text-gray-900 whitespace-nowrap">Michael Toohig</span></a><div class="items-center flex md:hidden"><button class="items-center dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex p-2.5 rounded-lg text-sm dark:hover:bg-gray-700 text-muted" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=ph:sun height=1em width=1em><symbol id=ai:ph:sun viewBox="0 0 256 256"><path d="M120 40V16a8 8 0 0 1 16 0v24a8 8 0 0 1-16 0m72 88a64 64 0 1 1-64-64a64.07 64.07 0 0 1 64 64m-16 0a48 48 0 1 0-48 48a48.05 48.05 0 0 0 48-48M58.34 69.66a8 8 0 0 0 11.32-11.32l-16-16a8 8 0 0 0-11.32 11.32Zm0 116.68l-16 16a8 8 0 0 0 11.32 11.32l16-16a8 8 0 0 0-11.32-11.32M192 72a8 8 0 0 0 5.66-2.34l16-16a8 8 0 0 0-11.32-11.32l-16 16A8 8 0 0 0 192 72m5.66 114.34a8 8 0 0 0-11.32 11.32l16 16a8 8 0 0 0 11.32-11.32ZM48 128a8 8 0 0 0-8-8H16a8 8 0 0 0 0 16h24a8 8 0 0 0 8-8m80 80a8 8 0 0 0-8 8v24a8 8 0 0 0 16 0v-24a8 8 0 0 0-8-8m112-88h-24a8 8 0 0 0 0 16h24a8 8 0 0 0 0-16" fill=currentColor /></symbol><use href=#ai:ph:sun></use></svg></button> <button class="items-center transition dark:focus:ring-gray-700 dark:hover:bg-gray-800 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex ml-1.5 p-2.5 rounded-lg text-gray-500 text-sm" aria-label="Toggle Menu" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=ph:dots-three-vertical height=1em width=1em><symbol id=ai:ph:dots-three-vertical viewBox="0 0 256 256"><path d="M140 128a12 12 0 1 1-12-12a12 12 0 0 1 12 12m-12-56a12 12 0 1 0-12-12a12 12 0 0 0 12 12m0 112a12 12 0 1 0 12 12a12 12 0 0 0-12-12" fill=currentColor /></symbol><use href=#ai:ph:dots-three-vertical></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center hidden md:flex dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href=/about class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-primary px-4 py-3 transition">About</a></li><li class=""><a href=/projects class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-primary px-4 py-3 transition">Projects</a></li><li class=""><a href=/blog class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-primary px-4 py-3 transition">Blog</a></li><li class=""><a href=/blurbs class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-primary px-4 py-3 transition">Blurbs</a></li><li class=""><a href=/links class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-primary px-4 py-3 transition">Links</a></li></ul></nav><div class="items-center flex md:mb-0 md:self-center"><div class="items-center hidden md:flex"><button class="items-center dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex p-2.5 rounded-lg text-sm dark:hover:bg-gray-700 text-muted" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-5 w-5" data-icon=ph:sun height=1em width=1em viewBox="0 0 256 256"><use href=#ai:ph:sun></use></svg></button></div></div></div></header><main><section class="mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p><svg class="dark:text-gray-400 -mt-0.5 h-4 inline-block w-4" data-icon=ph:timer height=1em width=1em><symbol id=ai:ph:timer viewBox="0 0 256 256"><path d="M128 40a96 96 0 1 0 96 96a96.11 96.11 0 0 0-96-96m0 176a80 80 0 1 1 80-80a80.09 80.09 0 0 1-80 80m45.66-125.66a8 8 0 0 1 0 11.32l-40 40a8 8 0 0 1-11.32-11.32l40-40a8 8 0 0 1 11.32 0M96 16a8 8 0 0 1 8-8h48a8 8 0 0 1 0 16h-48a8 8 0 0 1-8-8" fill=currentColor /></symbol><use href=#ai:ph:timer></use></svg> <time datetime="Tue Aug 01 2023 20:00:00 GMT-0400 (Eastern Daylight Time)">Aug 2, 2023</time> Â· 9 min read</p></div><h1 class="mx-auto sm:px-6 max-w-3xl px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Custom Extensions for Directus</h1><p class="mx-auto sm:px-6 max-w-3xl px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><img alt="How to get started with self-hosting Directus and write custom extensions." class="mx-auto bg-gray-400 dark:bg-slate-700 dark:lg:shadow-orange-200 lg:max-w-6xl lg:ring-2 lg:shadow-lg max-w-full mb-6 ring-none ring-opacity-50 ring-orange-500 sm:rounded-md" decoding=async height=506 loading=eager sizes="(max-width: 900px) 400px, 900px" src=/_astro/cover.D42Nh0OP_2bS0jh.webp width=900 aspectRatio=1.7777777777777777 srcset="/_astro/cover.D42Nh0OP_2bS0jh.webp 400w, /_astro/cover.D42Nh0OP_2bS0jh.webp 900w"></header><div class="mx-auto sm:px-6 max-w-3xl px-6 mt-8 dark:prose-a:text-orange-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl prose prose-a:text-orange-600 prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-lg prose-li:my-0 prose-md prose-table:max-w-10 prose-table:overflow-x-scroll prose-table:table-auto"><p>For the <a href=https://sabdivisen.com>Sabdivisen.com</a> project I needed a headless <abbr title="Content Management System">CMS</abbr> that would provide a great experience for the client and also for myself. Most importantly, I wanted a CMS that I could be confident I could extend easily if I found myself needing an unique feature. One such feature I knew I would need early in the project planning was a way to allow the client to upload their <abbr title="Keyhole Markup Language (used by Google Maps)">KML</abbr> files and transparently convert them to GeoJSON for use by the frontend. This will avoid requiring the client to pre-process files and hopefully make the experience more seamless for them as they can continue to use the file formats they are familar with.</p><p>After reviewing several options I decided on using <a href=https://directus.io>Directus</a>. However, adding custom extensions to Directus has one hang-up, it requires either an <em>Enterprise Cloud</em> subscription or you must self-host. I opted to self-host Directus.</p><h2 id=self-hosting-directus>Self-Hosting Directus</h2><p>To begin, I organized the project files as follows for reference. The <code>backend</code> directory contains code and data for Directus while the <code>frontend</code> directory contains Sabdivisen.comâ€™s public Vue.js website.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=txt data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">Directory Tree</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=txt data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=txt data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span>.</span></span>
<span data-line=""><span>â”œâ”€â”€ </span><mark data-highlighted-chars=""><span>backend</span></mark></span>
<span data-line=""><span>â”‚   â”œâ”€â”€ </span><mark data-highlighted-chars=""><span>extensions</span></mark></span>
<span data-line=""><span>â”‚   â””â”€â”€ uploads</span></span>
<span data-line=""><span>â”œâ”€â”€ frontend</span></span>
<span data-line=""><span>â”‚   â””â”€â”€ ...</span></span>
<span data-line=""><span>â””â”€â”€ docker-compose.yml</span></span></code></pre></figure><p>The <code>docker-compose.yml</code> file below is a slightly modified version of the sample found in the documentation provided by Directus and highlighted below is the key line that mounts our local extensions directory for loading extensions into Directus.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=yml data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">docker-compose.yml</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>version</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>3</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>services</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>  database</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    image</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> postgis/postgis:13-master</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    volumes</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> ./data/database:/var/lib/postgresql/data</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    environment</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      POSTGRES_USER</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      POSTGRES_PASSWORD</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      POSTGRES_DB</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>  cache</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    image</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> redis:6</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>  directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    image</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> directus/directus:10.1.0</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    ports</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> 8055:8055</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    volumes</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> ./backend/uploads:/directus/uploads</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> ./backend/extensions:/directus/extensions</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    depends_on</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> cache</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      -</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> database</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    environment</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      KEY</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>255d861b-5ea1-5996-9aa3-922530ec40b1</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      SECRET</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>6116487b-cda1-52c2-b5b5-c8022c45e263</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_CLIENT</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>pg</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_HOST</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>database</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_PORT</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>5432</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_DATABASE</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_USER</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      DB_PASSWORD</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      CACHE_ENABLED</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>true</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      CACHE_STORE</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>redis</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      REDIS</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>redis://cache:6379</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      ADMIN_EMAIL</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>admin@example.com</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      ADMIN_PASSWORD</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>d1r3ctu5</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      # Make sure to set this in production</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      # (see https://docs.directus.io/self-hosted/config-options#general)</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      # PUBLIC_URL: &#39;https://directus.example.com&#39;</span></span></code></pre></figure><p>The next time Directus is restarted the local <code>extensions</code> directory will be populated as seen below.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=txt data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">Directory Tree Updated</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=txt data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=txt data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span>.</span></span>
<span data-line=""><span>â”œâ”€â”€ </span><mark data-highlighted-chars=""><span>backend</span></mark></span>
<span data-line=""><span>â”‚   â”œâ”€â”€ </span><mark data-highlighted-chars=""><span>extensions</span></mark></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ displays</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ endpoints</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ hooks</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ interfaces</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ layouts</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ modules</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â”œâ”€â”€ operations</span></span>
<span data-line="" data-highlighted-line=""><span>â”‚   â”‚   â””â”€â”€ panels</span></span>
<span data-line=""><span>â”‚   â””â”€â”€ uploads</span></span>
<span data-line=""><span>â”œâ”€â”€ frontend</span></span>
<span data-line=""><span>â”‚   â””â”€â”€ ...</span></span>
<span data-line=""><span>â””â”€â”€ docker-compose.yml</span></span></code></pre></figure><p>Directus will scan these new dirctories for any Javascript modules and attempt to load them as an extension. Directus will see a file such as <code>./backend/extensions/endpoints/my-endpoint/index.js</code> and attempt to load the <code>my-endpoint</code> custom API endpoint or <code>./backend/extensions/hooks/my-hook/index.js</code> and attempt to load the <code>my-hook</code> custom API hook. Now we can write an extension.</p><h2 id=writing-the-extension>Writing the Extension</h2><p>The <a href=https://docs.directus.io/extensions/introduction.html>documentation for extensions</a> is decent but I feel some examples are shallow or require you to dig around the docs to see the whole picture, so Iâ€™ll write the following out almost step-by-step.</p><h3 id=extension-types>Extension Types</h3><p>There are many extesion types as you may have noticed when Directus populated the <code>extensions</code> directory. The 8 extension types can be combined to create even greater customizations. In the docs they describe this as an <a href=https://docs.directus.io/extensions/bundles.html>extension bundle</a> and provide tools to help build them.</p><p>I chose to write an <a href=https://docs.directus.io/extensions/hooks.html>API Hook extension</a> because it allows us to run custom logic whenver specific events occur. The hook would allow us to inspect a subdivision payload, read the KML file, do some processing to generate the GeoJSON data from the KML contents and finally commit the modified payload to the database.</p><blockquote><p>I should mention that this could be done with a webhook to an external service as well. Although, as a webook the custom logic would be done asynchronously and we would not be able to interrupt the database transaction so thatâ€™s why I went with API hook extension instead.</p></blockquote><h3 id=creating-the-data-model>Creating The Data Model</h3><p>First, I created a <code>Subdivisions</code> collection in Directus which means behind the scenes Directus will create a table in the database for our subdivision data and Directus will provide us an API to interact with this table.</p><p>For this demostration we only need two fields in our table. A <code>File</code> type field named <code>kml</code> is created to store the uploaded KML file and a <code>Map</code> type field named <code>polygon</code> is created to store the GeoJSON data.</p><img alt="KML and Map fields" class="mx-auto w-full rounded-md" decoding=async height=1843 loading=lazy sizes="(max-width: 767px) 400px, (max-width: 1023px) 768px, (max-width: 2039px) 1024px, 2040px" src=/_astro/fields.CyELHSVz_1UGC1y.webp width=2040><p>You can polish things further by making the <code>polygon</code> field hidden or read-only so that only a new KML file can overwrite the <code>polygon</code> value. Then, you can update the access controls so the API response will not contain the <code>kml</code> field and your frontend will only receive the prepared GeoJSON data in the <code>polygon</code> field.</p><h3 id=actually-writing-the-extension>Actually Writing the Extension</h3><p>First letâ€™s create a no-op extension. This hook will do nothing but prove that Directus is configured correctly and our extensions are loading successfully. Notice this is a hook extension that uses the <code>filter</code> event, there are <a href=https://docs.directus.io/extensions/hooks.html#events>other events</a> you may consider for your usecase.</p><p>I wrote the API hook extension in the file <code>./backend/extensions/hooks/kml-converter/index.js</code> so that Directus knows this code is a hook and it is called <code>kml-converter</code>.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=js data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">backend/extensions/hooks/kml-converter/index.js</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> defineHook </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>@directus/extensions-sdk</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>export</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> default</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> defineHook</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  ({</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>filter</span></mark><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>})</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>filter</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>items.create</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>filter</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>items.update</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span></code></pre></figure><p>When you restart the Directus container you should see the following log which shows our extension has successfully loaded.</p><figure data-rehype-pretty-code-figure=""><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=sh data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=sh data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>directus</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> |</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> [</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>04:58:00.180</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>]</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> INFO:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> Loaded</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> extensions:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>kml-converter</span></mark></span></code></pre></figure><p>However, this extension listens to every <code>create</code> and <code>update</code> event which is unnecessary for our use-case. We can add the collection name to our filter to limit our hook to only events that create or update the <code>Subdivisions</code> collection. Or alternatively, I could have used an <code>if</code> statement to check the value of <code>collection</code> is equal to <code>Subdivisions</code>.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=js data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">backend/extensions/hooks/kml-converter/index.js</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> defineHook </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>@directus/extensions-sdk</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>export</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> default</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> defineHook</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  ({</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> filter </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>})</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><mark data-highlighted-chars=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions</span></mark><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>.items.create</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><mark data-highlighted-chars=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions</span></mark><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>.items.update</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span></code></pre></figure><p>Now the hook can act on the correct events, so I create a dummy function <code>convertKmlToGeoJSON</code> which is where I will actually do the real work of converting the KML file to GeoJSON soon. Also, take note that the <code>update</code> hook specifically checks if the <code>kml</code> property exists on <code>input</code> because if the KML file does not change during an update then it wonâ€™t be present on the <code>input</code> object and we can return as we donâ€™t need to update the existing GeoJSON data.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=js data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">backend/extensions/hooks/kml-converter/index.js</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> defineHook </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>@directus/extensions-sdk</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>export</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> default</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> defineHook</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  ({</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> filter </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>})</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>    const</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>convertKmlToGeoJSON</span></mark><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kmlAssetId</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F> undefined</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions.items.create</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>convertKmlToGeoJSON</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>      input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions.items.update</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      if</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>!</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>hasOwnProperty</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>))</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>convertKmlToGeoJSON</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>      input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span></code></pre></figure><h4 id=adding-packages-to-the-environment>Adding Packages to the Environment</h4><p>To convert the KML files easily I wanted to use the <code>togeojson</code> package that was built for converting KML to GeoJSON <span aria-label="face with rolling eyes" role=img>ðŸ™„</span>â€¦duh. But this package is not available in Directus by default so it is not available to the extension either.</p><blockquote><p>There is another way to add packages, see the <code>Conclusion</code> at end of this post for more information.</p></blockquote><p>To install additional packages into the Directus environment I had to modify the <code>docker-compose.yml</code> file and include a new <code>Dockerfile</code> in the <code>backend</code> directory. Instead of using the official Directus image I am building a new image ontop of the official image.</p><figure data-rehype-pretty-code-figure=""><figcaption data-language=yml data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">docker-compose.yml (snippet)</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>services</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>  directus</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    # image: directus/directus:10.1.0</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    container_name</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> directus</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>    build</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> backend</span></span>
<span data-line=""><span style=--shiki-dark:#CC6666;--shiki-light:#CC6666>      dockerfile</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>:</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> Dockerfile</span></span>
<span data-line=""><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F>  ...</span></span></code></pre></figure><blockquote><p>I go through the hassle of installing pnpm because I already use it for the frontend codebase and wanted consistencyâ€¦ <span aria-label="" role=img aria-hidden=true>ðŸ¤·</span></p></blockquote><figure data-rehype-pretty-code-figure=""><figcaption data-language=yml data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">backend/Dockerfile</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=yml data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>FROM directus/directus:10.1.0</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>USER root</span></span>
<span data-line=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>RUN corepack enable &amp;&amp; corepack prepare pnpm@8.3.1 --activate</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>USER node</span></span>
<span data-line=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>RUN pnpm install </span><mark data-highlighted-chars=""><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>togeojson</span></mark><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440> xmldom stream-to-string</span></span></code></pre></figure><p>Later I had to install a couple other packages to handle the KML file itself as you will see.</p><h4 id=the-final-extension-with-error-handling>The Final Extension with Error handling</h4><p>Now, I can put the whole thing together. Only 3 lines are actually converting the KML file (thanks <code>togeojson</code>). The remaining lines are handling the KML file itself and handling errors.</p><p>File type fields in Directus are a relationship to the <code>Assets</code> table so the field only contains the asset ID. I had to use the <code>AssetsService</code> to obtain the file stream so that I could access its contents.</p><p>The great majority of lines are error handling. I found when the extension fails the user will only receive a generic internal server type error which certainly doesnâ€™t help them. Instead I raise the <code>InvalidPayloadException</code> where ever I can to provide useful information to the user, especialy since many errors were due to bad KML files and with useful error messages the client could then fix it themselves.</p><blockquote><p>I renamed the function here <code>convertKmlToPolygon</code> to match its use as I only want the <code>coordinates</code> field from the GeoJSON object.</p></blockquote><figure data-rehype-pretty-code-figure=""><figcaption data-language=js data-rehype-pretty-code-title="" data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)">backend/extensions/hooks/kml-converter/index.js</figcaption><pre class="(Straight) (Straight) - - Remedy Remedy Bright Dark" data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=--shiki-dark:#F9E7C4;--shiki-light:#594318;--shiki-dark-bg:#403A35;--shiki-light-bg:#FFF9EC tabindex=0><code data-language=js data-theme="Remedy - Dark (Straight) Remedy - Bright (Straight)" style=display:grid><span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> defineHook </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>@directus/extensions-sdk</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> DOMParser </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>xmldom</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> toGeoJSON </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>togeojson</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>import</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> streamToString </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>from</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> &quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>stream-to-string</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>export</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> default</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> defineHook</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  ({</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> filter </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> exceptions</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> services </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>})</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>    const</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>InvalidPayloadException</span></mark><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> exceptions</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>    const</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> AssetsService </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> services</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>    const</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> convertKmlToPolygon</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kmlAssetId</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      // get the kml file</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> assets </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> AssetsService</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> stream </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> assets</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>getAsset</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kmlAssetId</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {});</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>      </span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      // convert kml to geojson</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> doc </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> streamToString</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>stream</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> kml </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> DOMParser</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>().</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>parseFromString</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>doc</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span>
<span data-line="" data-highlighted-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> gj </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> toGeoJSON</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      // sanity check</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      if</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>!</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>gj</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>hasOwnProperty</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>features</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>))</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        throw</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>InvalidPayloadException</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>KML file does not have features.</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      // grab geometry data from geojson and remove Z value from coordinates</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      let</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> geometry </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> gj</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>features</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>?.[</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F>0</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>]?.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>geometry</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      if</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>geometry </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>===</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F> undefined</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        throw</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>InvalidPayloadException</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>KML file does not have geometry.</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> coords </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> geometry</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>coordinates</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>[</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F>0</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>].</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>map</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>((</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>coord</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> [</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>coord</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>[</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F>0</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>],</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> coord</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>[</span><span style=--shiki-dark:#DE935F;--shiki-light:#DE935F>1</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>]])</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>      geometry</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>coordinates </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> [</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>coords</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>];</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> geometry</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions.items.create</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      try</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> convertKmlToPolygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>        input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> catch</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>        console</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        throw</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>InvalidPayloadException</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>`</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Failed to convert KML file. </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>${</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}`</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""> </span>
<span data-line=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>    filter</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Subdivisions.items.update</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&quot;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> async</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> collection </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>},</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> =&gt;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      // return if `kml` column is not updated</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      if</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>!</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>hasOwnProperty</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>&#39;</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>))</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>      try</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        const</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> await</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> convertKmlToPolygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>kml</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>,</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> context</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>        input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>polygon </span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>=</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> polygon</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        return</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318> input</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>;</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> catch</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> (</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72> {</span></span>
<span data-line=""><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>        console</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>.</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#B294BB;--shiki-light:#85678F>        throw</span><span style=--shiki-dark:#B294BB;--shiki-light:#85678F> new</span><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D> </span><mark data-highlighted-chars=""><span style=--shiki-dark:#81A2BE;--shiki-light:#5F819D>InvalidPayloadException</span></mark><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>(</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>`</span><span style=--shiki-dark:#B5BD68;--shiki-light:#8C9440>Failed to convert KML file. </span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>${</span><span style=--shiki-dark:#F9E7C4;--shiki-light:#594318>error</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>}`</span><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>);</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>      }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>    });</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>  }</span></span>
<span data-line=""><span style=--shiki-dark:#81755D;--shiki-light:#B19C72>)</span></span></code></pre></figure><h2 id=conclusion>Conclusion</h2><p>The way I added this extension to Directus is one way to do so but probably best for small extensions. The other way is with the <code>create-directus-extension</code> utility which you can read more about <a href=https://docs.directus.io/extensions/creating-extensions.html>here</a>. The advantage being you can keep dependencies of your extensions seperate from Directus and other extensions and publish your extension as a package for others to use.</p></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="dark:bg-slate-700 bg-gray-100 font-medium inline-block lowercase mb-2 mr-2 px-2 py-0.5">directus</li><li class="dark:bg-slate-700 bg-gray-100 font-medium inline-block lowercase mb-2 mr-2 px-2 py-0.5">docker</li></ul><div class="align-middle dark:text-slate-600 mt-5 sm:mt-1 text-gray-500"><span class="font-bold align-super dark:text-slate-400 text-gray-400">Share:</span> <button class=ml-2 data-aw-social-share=twitter data-aw-url=https://michaeltoohig.com/blog/directus-extensions title="Twitter Share" data-aw-text="Custom Extensions for Directus"><svg class="h-6 w-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon=ri:twitter-fill height=1em width=1em><symbol id=ai:ri:twitter-fill viewBox="0 0 24 24"><path d="M22.213 5.656a8.4 8.4 0 0 1-2.402.658A4.2 4.2 0 0 0 21.649 4c-.82.488-1.719.83-2.655 1.015a4.182 4.182 0 0 0-7.126 3.814a11.87 11.87 0 0 1-8.621-4.37a4.17 4.17 0 0 0-.566 2.103c0 1.45.739 2.731 1.86 3.481a4.2 4.2 0 0 1-1.894-.523v.051a4.185 4.185 0 0 0 3.355 4.102a4.2 4.2 0 0 1-1.89.072A4.185 4.185 0 0 0 8.02 16.65a8.4 8.4 0 0 1-6.192 1.732a11.83 11.83 0 0 0 6.41 1.88c7.694 0 11.9-6.373 11.9-11.9q0-.271-.012-.541a8.5 8.5 0 0 0 2.086-2.164" fill=currentColor /></symbol><use href=#ai:ri:twitter-fill></use></svg></button> <button class=ml-2 data-aw-social-share=facebook data-aw-url=https://michaeltoohig.com/blog/directus-extensions title="Facebook Share"><svg class="h-6 w-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon=ri:facebook-box-fill height=1em width=1em><symbol id=ai:ri:facebook-box-fill viewBox="0 0 24 24"><path d="M15.402 21v-6.966h2.333l.349-2.708h-2.682V9.599c0-.784.218-1.319 1.342-1.319h1.434V5.857a19 19 0 0 0-2.09-.107c-2.067 0-3.482 1.262-3.482 3.58v1.996h-2.338v2.708h2.338V21H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1z" fill=currentColor /></symbol><use href=#ai:ri:facebook-box-fill></use></svg></button> <button class=ml-2 data-aw-social-share=linkedin data-aw-url=https://michaeltoohig.com/blog/directus-extensions title="Linkedin Share" data-aw-text="Custom Extensions for Directus"><svg class="h-6 w-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon=ri:linkedin-box-fill height=1em width=1em><symbol id=ai:ri:linkedin-box-fill viewBox="0 0 24 24"><path d="M18.336 18.339h-2.665v-4.177c0-.996-.02-2.278-1.39-2.278c-1.389 0-1.601 1.084-1.601 2.205v4.25h-2.666V9.75h2.56v1.17h.035c.358-.674 1.228-1.387 2.528-1.387c2.7 0 3.2 1.778 3.2 4.092v4.714M7.004 8.575a1.546 1.546 0 0 1-1.548-1.549a1.548 1.548 0 1 1 1.547 1.549m1.336 9.764H5.667V9.75H8.34zM19.67 3H4.33C3.594 3 3 3.58 3 4.297v15.406C3 20.42 3.594 21 4.328 21h15.339C20.4 21 21 20.42 21 19.703V4.297C21 3.581 20.4 3 19.666 3z" fill=currentColor /></symbol><use href=#ai:ri:linkedin-box-fill></use></svg></button> <button class=ml-2 data-aw-social-share=whatsapp data-aw-url=https://michaeltoohig.com/blog/directus-extensions title="Whatsapp Share" data-aw-text="Custom Extensions for Directus"><svg class="h-6 w-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon=ri:whatsapp-fill height=1em width=1em><symbol id=ai:ri:whatsapp-fill viewBox="0 0 24 24"><path d="M12.001 2c5.523 0 10 4.477 10 10s-4.477 10-10 10a9.95 9.95 0 0 1-5.03-1.355L2.005 22l1.352-4.968A9.95 9.95 0 0 1 2.001 12c0-5.523 4.477-10 10-10M8.593 7.3l-.2.008a1 1 0 0 0-.372.1a1.3 1.3 0 0 0-.294.228c-.12.113-.188.211-.261.306A2.73 2.73 0 0 0 6.9 9.62c.002.49.13.967.33 1.413c.409.902 1.082 1.857 1.97 2.742c.214.213.424.427.65.626a9.45 9.45 0 0 0 3.84 2.046l.568.087c.185.01.37-.004.556-.013a2 2 0 0 0 .833-.231a5 5 0 0 0 .383-.22q.001.002.125-.09c.135-.1.218-.171.33-.288q.126-.13.21-.302c.078-.163.156-.474.188-.733c.024-.198.017-.306.014-.373c-.004-.107-.093-.218-.19-.265l-.582-.261s-.87-.379-1.402-.621a.5.5 0 0 0-.176-.041a.48.48 0 0 0-.378.127c-.005-.002-.072.055-.795.931a.35.35 0 0 1-.368.13a1.4 1.4 0 0 1-.191-.066c-.124-.052-.167-.072-.252-.108a6 6 0 0 1-1.575-1.003c-.126-.11-.243-.23-.363-.346a6.3 6.3 0 0 1-1.02-1.268l-.059-.095a1 1 0 0 1-.102-.205c-.038-.147.061-.265.061-.265s.243-.266.356-.41c.11-.14.203-.276.263-.373c.118-.19.155-.385.093-.536q-.42-1.026-.868-2.041c-.059-.134-.234-.23-.393-.249q-.081-.01-.162-.016a3 3 0 0 0-.403.004z" fill=currentColor /></symbol><use href=#ai:ri:whatsapp-fill></use></svg></button> <button class=ml-2 data-aw-social-share=mail data-aw-url=https://michaeltoohig.com/blog/directus-extensions title="Email Share" data-aw-text="Custom Extensions for Directus"><svg class="h-6 w-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon=ri:mail-fill height=1em width=1em><symbol id=ai:ri:mail-fill viewBox="0 0 24 24"><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m9.06 8.683L5.648 6.238L4.353 7.762l7.72 6.555l7.581-6.56l-1.308-1.513z" fill=currentColor /></symbol><use href=#ai:ri:mail-fill></use></svg></button></div></div></article></section><div class="mx-auto sm:px-6 max-w-3xl px-6 md:pb-20 md:pt-4 pb-12 pt-8"><a href=/blog class="btn btn-ghost md:px-3 px-3"><svg class="h-5 w-5 -ml-1.5 mr-1" data-icon=ph:arrow-fat-left height=1em width=1em><symbol id=ai:ph:arrow-fat-left viewBox="0 0 256 256"><path d="M208 72h-80V32a8 8 0 0 0-13.66-5.66l-96 96a8 8 0 0 0 0 11.32l96 96A8 8 0 0 0 128 224v-40h80a16 16 0 0 0 16-16V88a16 16 0 0 0-16-16m0 96h-88a8 8 0 0 0-8 8v28.69L35.31 128L112 51.31V80a8 8 0 0 0 8 8h88Z" fill=currentColor /></symbol><use href=#ai:ph:arrow-fat-left></use></svg> Back to Blog</a></div><section class="bg-opacity-50 bg-orange-200 dark:bg-slate-800 lg:mb-20 max-w-3xl mb-16 md:mx-auto mx-4 pb-2 rounded-sm"><div class="mx-auto sm:px-6 font-medium px-2 py-4 text-left text-lg"><span class="font-bold text-primary"><svg class="h-5 w-5 align-text-bottom inline-block" data-icon=ph:info height=1em width=1em><symbol id=ai:ph:info viewBox="0 0 256 256"><path d="M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24m0 192a88 88 0 1 1 88-88a88.1 88.1 0 0 1-88 88m16-40a8 8 0 0 1-8 8a16 16 0 0 1-16-16v-40a8 8 0 0 1 0-16a16 16 0 0 1 16 16v40a8 8 0 0 1 8 8m-32-92a12 12 0 1 1 12 12a12 12 0 0 1-12-12" fill=currentColor /></symbol><use href=#ai:ph:info></use></svg> FYI: </span>This post is a part of the following project.</div><div class="px-2 sm:px-6"><article class="mb-6 transition"><div class="dark:bg-slate-700 bg-gray-400 mb-6 md:h-88 relative rounded shadow-lg"><a href=/projects/sabdivisen><img alt=Sabdivisen.com class="w-full md:w-auto bg-gray-400 dark:bg-slate-700 md:h-full md:object-cover rounded shadow-lg" decoding=async height=224 loading=lazy sizes="(max-width: 900px) 400px, 900px" src=/_astro/sabdivisen.Ch0k0FnW_1FMYGB.webp width=400 aspectRatio=16:9 srcset="/_astro/sabdivisen.Ch0k0FnW_1FMYGB.webp 400w, /_astro/sabdivisen.Ch0k0FnW_1FMYGB.webp 900w"></a></div><h3 class="font-bold font-heading leading-tight mb-2 sm:text-2xl text-xl"><a href=/projects/sabdivisen class="dark:hover:text-primary duration-200 ease-in hover:text-primary transition">Sabdivisen.com</a></h3><p class="dark:text-slate-400 text-muted text-lg">Vanuatu&#39;s map for subdivisions.</p></article></div></section></main><footer class="border-gray-200 border-t dark:border-slate-800 relative"><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="mx-auto sm:px-6 px-4 dark:text-slate-300 max-w-7xl relative"><div class="py-8 gap-4 gap-y-8 grid grid-cols-12 md:py-12 sm:gap-8"><div class="col-span-12 lg:col-span-4"><div class=mb-2><a href=/ class="font-bold text-xl inline-block">Michael Toohig</a></div></div></div><div class="md:items-center md:flex md:justify-between md:py-8 py-6"><ul class="flex md:mb-0 -ml-2 mb-4 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex p-2.5 rounded-lg text-sm dark:hover:bg-gray-700 text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=ph:rss height=1em width=1em><symbol id=ai:ph:rss viewBox="0 0 256 256"><path d="M106.91 149.09A71.53 71.53 0 0 1 128 200a8 8 0 0 1-16 0a56 56 0 0 0-56-56a8 8 0 0 1 0-16a71.53 71.53 0 0 1 50.91 21.09M56 80a8 8 0 0 0 0 16a104 104 0 0 1 104 104a8 8 0 0 0 16 0A120 120 0 0 0 56 80m118.79 1.21A166.9 166.9 0 0 0 56 32a8 8 0 0 0 0 16a151 151 0 0 1 107.48 44.52A151 151 0 0 1 208 200a8 8 0 0 0 16 0a166.9 166.9 0 0 0-49.21-118.79M60 184a12 12 0 1 0 12 12a12 12 0 0 0-12-12" fill=currentColor /></symbol><use href=#ai:ph:rss></use></svg></a></li><li><a href=https://github.com/michaeltoohig class="items-center dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex p-2.5 rounded-lg text-sm dark:hover:bg-gray-700 text-muted" aria-label=Github><svg class="h-5 w-5" data-icon=ph:github-logo height=1em width=1em><symbol id=ai:ph:github-logo viewBox="0 0 256 256"><path d="M208.31 75.68A59.78 59.78 0 0 0 202.93 28a8 8 0 0 0-6.93-4a59.75 59.75 0 0 0-48 24h-24a59.75 59.75 0 0 0-48-24a8 8 0 0 0-6.93 4a59.78 59.78 0 0 0-5.38 47.68A58.14 58.14 0 0 0 56 104v8a56.06 56.06 0 0 0 48.44 55.47A39.8 39.8 0 0 0 96 192v8H72a24 24 0 0 1-24-24a40 40 0 0 0-40-40a8 8 0 0 0 0 16a24 24 0 0 1 24 24a40 40 0 0 0 40 40h24v16a8 8 0 0 0 16 0v-40a24 24 0 0 1 48 0v40a8 8 0 0 0 16 0v-40a39.8 39.8 0 0 0-8.44-24.53A56.06 56.06 0 0 0 216 112v-8a58.14 58.14 0 0 0-7.69-28.32M200 112a40 40 0 0 1-40 40h-48a40 40 0 0 1-40-40v-8a41.74 41.74 0 0 1 6.9-22.48a8 8 0 0 0 1.1-7.69a43.8 43.8 0 0 1 .79-33.58a43.88 43.88 0 0 1 32.32 20.06a8 8 0 0 0 6.71 3.69h32.35a8 8 0 0 0 6.74-3.69a43.87 43.87 0 0 1 32.32-20.06a43.8 43.8 0 0 1 .77 33.58a8.09 8.09 0 0 0 1 7.65a41.7 41.7 0 0 1 7 22.52Z" fill=currentColor /></symbol><use href=#ai:ph:github-logo></use></svg></a></li></ul><div class="dark:text-slate-400 mr-4 text-sm">Made in Vanuatu ðŸ‡»ðŸ‡º Â· All rights reserved.</div></div></div></footer><script>!function(){const e="system";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||(localStorage.theme,0)?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function a(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light")})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),a=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(o){case"facebook":c=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${n}&text=${a}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${a}`;break;case"whatsapp":c=`https://wa.me/?text=${a}%20${n}`;break;case"mail":c=`mailto:?subject=%22${a}%22&body=${a}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=c,s.click()})),a(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{a()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>